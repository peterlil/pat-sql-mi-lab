param (
    $dtap,
    $sourcePath,
    $SourceVersion,
    $WhatIf
)

function Format-ValidationOutput {
    param ($ValidationOutput, [int] $Depth = 0)
    Set-StrictMode -Off
    return @($ValidationOutput | Where-Object { $_ -ne $null } | ForEach-Object { @("  " * $Depth + $_.Code + ": " + $_.Message) + @(Format-ValidationOutput @($_.Details) ($Depth + 1)) })
}

function deployTemplate($fullPath, $SourceVersion) {
    ###############################################################################
    # Deploy a template
    ###############################################################################

    # Regular expressions patterns
    $pathNoFilenameRegexPattern = "[\w\s-.\\:]+(?=azuredeploy[\w\s-.]*.parameters.json$)"
    $jsonParamFileRegexPattern = "azuredeploy[\w\s-.]*.parameters.json$"
    $rgNamePattern = "(?<=resource-groups\\)[\w\s-.]+"

    $path = [System.Text.RegularExpressions.Regex]::Match($fullPath, $pathNoFilenameRegexPattern).Value
    Write-Host "##########################################################################################"
    Write-Host "Deployment of $($fullPath)"
    Write-Host "Path: $($path)"
    $jsonParameterFileName = [System.Text.RegularExpressions.Regex]::Match($fullPath, $jsonParamFileRegexPattern).Value
    $jsonParameterFullFileName = "$($path)$($jsonParameterFileName)"
    Write-Host "Template parameters filename: $($jsonParameterFileName)"
    Write-Host "Template parameters full filename: $($jsonParameterFullFileName)"
    
    $rgName = [System.Text.RegularExpressions.Regex]::Match($fullPath, $rgNamePattern).Value
    Write-Host "Resource Group Name: $($rgName)"
    $jsonTemplateFileName = $path + ($jsonParameterFileName.ToLower().Replace(".development.", ".").Replace(".dev.", ".").Replace(".test.", ".").Replace(".uat.", ".").Replace(".acc.", ".").Replace(".production.", ".").Replace(".prod.", ".").Replace(".parameters.", "."))
    Write-Host "Template file name: $($jsonTemplateFileName)"

    # Load the parameter file and set parameter(s)
    $params = ((Get-Content -Raw $fullPath) | ConvertFrom-Json)
    $location = $params.parameters.location.value

    # Make sure the resource group exists
    Write-Host "Checking if Resource Group $($rgName) exists"
    $rg = Get-AzureRmResourceGroup -Name $rgName -ErrorAction SilentlyContinue
    if($rg) {
        Write-Host "Resource group $($rgName) already exists, no need to create."
    } else {
        Write-Host "Creating resource group $($rgName)"
        $rg = New-AzureRmResourceGroup -Name $rgName -Location $location -ErrorAction Stop
    }
    Write-Host $jsonTemplateFileName
    Write-Host $jsonParameterFullFileName
    $ErrorMessages = @()
    if ($WhatIf -eq $true) {
        $ErrorMessages = Format-ValidationOutput ( Test-AzureRmResourceGroupDeployment `
            -ResourceGroupName $rgName `
            -TemplateFile $jsonTemplateFileName `
            -TemplateParameterFile $jsonParameterFullFileName `
            -Verbose)
    } else {
        $deployName = "$($rgName)-$($SourceVersion)"
        New-AzureRmResourceGroupDeployment -Name $deployName `
            -ResourceGroupName $rgName `
            -Mode Incremental `
            -TemplateFile $jsonTemplateFileName `
            -TemplateParameterFile $jsonParameterFullFileName `
            -Force `
            -Verbose `
            -ErrorVariable ErrorMessages

    }

    if ($ErrorMessages)
    {
        ("##vso[task.setvariable variable=ErrorMessage] {0}" -f ($ErrorMessages -Join "; ") )
        Write-Error "$($ErrorMessages -Join "; ")"
        exit 1
    }
}

###############################################################################
# Dump the parameters
###############################################################################
Write-Host ""
Write-Host "Dumping parameters:"
Write-Host "dtap: $dtap"
Write-Host "sourcePath: $sourcePath"
Write-Host "SourceVersion: $SourceVersion"
Write-Host "WhatIf: $WhatIf"

###############################################################################
# Find all parameter files for the current dtap
###############################################################################
$templateParameters = Get-ChildItem -Path $sourcePath -Include azuredeploy.*parameters.json -Recurse

Write-Host ""
Write-Host "Searching for template parameters files."
Write-Host "$($templateParameters.Count) parameter file(s) found"
Write-Host "Listing files:"

# Loop through the configs and add the right files to the list, i.e. filter on dtap setting.
# This also filters the list in deployment order.
$unsortedList = @()
$logMsg = "";
Foreach ($file in $templateParameters) {
    $params = ((Get-Content -Raw $file) | ConvertFrom-Json)
    $logMsg = "$($params.parameters.dtap.value) - $($file.FullName)"
    if( $params.parameters.dtap.value -eq $dtap ) {
        Write-Host "To deploy: $logMsg"
        $templateParameters = New-Object -TypeName System.Object
        $templateParameters | Add-Member -MemberType NoteProperty -Name Path -Value $file.FullName
        $templateParameters | Add-Member -MemberType NoteProperty -Name Ring -Value $params.parameters.ring.value
        $unsortedList += $templateParameters
    } else {
        Write-Host "Not to deploy: $logMsg"        
    }
}

###############################################################################
# Find all powershell scripts for the current dtap
###############################################################################
$scriptFiles = Get-ChildItem -Path $sourcePath -Include pipeline-*.ps1 -Recurse

Write-Host ""
Write-Host "Searching for scripts."
Write-Host "$($scriptFiles.Count) scripts found"
Write-Host "Listing scripts:"

# Loop through the configs and add the right files to the list, i.e. filter on dtap setting.
# This also filters the list in deployment order.
$logMsg = "";
Foreach ($file in $scriptFiles) {
    # Parse out the ordinal number (execution order)
    $orderNoPattern = "(?<=pipeline-)[0-9]{3,3}(?=[\w\s-_.]*.ps1$)"
    $orderNo = [System.Text.RegularExpressions.Regex]::Match($file.FullName, $orderNoPattern).Value
    $logMsg = "$($orderNo) - $file"
    Write-Host "Script: $logMsg"

    $item = New-Object -TypeName System.Object
    $item | Add-Member -MemberType NoteProperty -Name Path -Value $file.FullName
    $item | Add-Member -MemberType NoteProperty -Name Ring -Value $orderNo
    $unsortedList += $item
}

$sortedRunlist = $unsortedList | Sort-Object -Property Ring

###############################################################################
# Loop through the list and deploy
###############################################################################

Write-Host ""
Write-Host "Run list:"
Foreach ($item in $sortedRunlist) {
    Write-Host $item.Path
}
Write-Host "Loop through each file and deploy"

$jsonParamFileRegexPattern = "azuredeploy[\w\s-.]*.parameters.json$"
#$lastDirRegexPattern = "[\w\s-.]+(?=\\azuredeploy[\w\s-.]*.parameters.json$)"
$rgNamePattern = "(?<=resource-groups\\)[\w\s-.]+"
$pathNoFilenameRegexPattern = "[\w\s-.\\:]+(?=azuredeploy[\w\s-.]*.parameters.json$)"

Foreach ($item in $sortedRunlist) {
    if ( $item.Path.Endswith(".json") -eq $true ) {
        ###############################################################################
        # Deploy a template
        ###############################################################################
        deployTemplate -fullPath $item.Path -SourceVersion $SourceVersion    
    } elseif ( $item.Path.Endswith(".ps1") -eq $true ) {
        ###############################################################################
        # Execute a script
        ###############################################################################
        Write-Host "##########################################################################################"
        Write-Host "Execution of $($item.Path)"
        & $item.Path -dtap $dtap -sourcePath $sourcePath -WhatIf $WhatIf
    } else {
        $errorMessage = "Not recognizable file format: $($item.Path). Item will not be deployed."
        ("##vso[task.setvariable variable=WarningMessage] {0}" -f ($errorMessage) )
        Write-Warning "$($errorMessage)"
    }
}

